version: 2.1

# -------------------------
#        COMMANDS
# -------------------------
commands:

  setup:
    steps:
      # for local builds, this needs to be checked out to `~/project`
      - checkout
      - run:
          name: Avoid hosts unknown for gitlab.gnome.org
          command: mkdir -p ~/.ssh/ && echo -e "Host gitlab.gnome.org\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

  cache-break:
    steps:
      - run:
          name: should cache break
          # Triggering cache changes should be done in the directories below
          command: |
            cache_break=$(md5 ports/cache_break)
            if [ ! -e "${HOME}/CACHE_BREAK" ] || [ "${cache_break}" != "$(cat "${HOME}/CACHE_BREAK")" ]; then
              echo "Cache break"
              echo "${cache_break}" > "${HOME}/CACHE_BREAK"
              # scripts/macports_uninstall.sh --formulas-only
            fi

  setup-macports:
    steps:
        - run:
            name: Install macports
            command: |
              scripts/macports0_install.sh
            no_output_timeout: 30m
        # - run:
        #     name: Gimp version (default `master`)
        #     command: |
        #       pushd ${HOME}/project/modulesets
        #           if [ ! -z "${BRANCH}" ]; then
        #               revision_or_tag="revision=\"${BRANCH}\""
        #           elif [ ! -z "${TAG}" ]; then
        #               revision_or_tag="tag=\"${TAG}\""
        #           else
        #               revision_or_tag="revision=\"master\""
        #           fi
        #           sed -e "s|%REVISION_OR_TAG%|${revision_or_tag}|g" \
        #               -e "s|%WARNING%|DO NOT EDIT THIS FILE. It is automatically generated from the modulesets/gtk-osx-gimp.modules.tmpl file.|g" \
        #               gtk-osx-gimp.modules.tmpl > gtk-osx-gimp.modules
        #       popd

# -------------------------
#        JOBS
# -------------------------
jobs:

  dependencies-part1:
    machine: true
    resource_class: gnome/gimp

    steps:
      - setup
      - cache-break
      - setup-macports
      - run:
          name: Build GIMP dependencies part 1
          command: |
            scripts/macports1_install_packages.sh --circleci --part1
          no_output_timeout: 30m

  dependencies-part2:
    machine: true
    resource_class: gnome/gimp

    steps:
      - setup
      - setup-macports
      - run:
          name: Build GIMP dependencies part 2
          command: |
            scripts/macports1_install_packages.sh --circleci --part2
          no_output_timeout: 30m

  dependencies-part3:
    machine: true
    resource_class: gnome/gimp

    steps:
      - setup
      - setup-macports
      - run:
          name: Build GIMP dependencies part 3
          command: |
            scripts/macports1_install_packages.sh --circleci --part3
          no_output_timeout: 30m

  dependencies-part4:
    machine: true
    resource_class: gnome/gimp

    steps:
      - setup
      - setup-macports
      - run:
          name: Build GIMP dependencies part 4
          command: |
            scripts/macports1_install_packages.sh --circleci --part4
          no_output_timeout: 30m

  dependencies-part5:
    machine: true
    resource_class: gnome/gimp

    steps:
      - setup
      - setup-macports
      - run:
          name: Build GIMP dependencies part 5
          command: |
            scripts/macports1_install_packages.sh --circleci --part5
          no_output_timeout: 30m

  build-gimp-and-package:
    machine: true
    resource_class: gnome/gimp

    steps:
      - setup
      - setup-macports
      - run:
          name: Build GIMP
          # XXX `make check` is not working reliably under circle ci, so we are
          # not using --check flag
          command: |
            scripts/macports2_install_gimp.sh circleci
      - run:
          name: Setup gtk-mac-bundler
          command: |
            if [ ! -d ~/Source/gtk-mac-bundler ]; then
              mkdir -p ~/Source
              cd ~/Source
              git clone https://gitlab.gnome.org/lukaso/gtk-mac-bundler
              cd gtk-mac-bundler
              make install
            fi
      - run:
          name: Importing signing certificate
          command: |
            mkdir ${HOME}/codesign && cd ${HOME}/codesign
            echo "$osx_crt" | base64 -D > gnome.pfx
            curl 'https://developer.apple.com/certificationauthority/AppleWWDRCA.cer' > apple.cer
            if [ -f "${HOME}/Library/Keychains/signchain-db" ]; then
              security delete-keychain signchain
            fi
            security create-keychain -p "" signchain
            security set-keychain-settings signchain
            security unlock-keychain -u signchain
            security list-keychains  -s "${HOME}/Library/Keychains/signchain-db" "${HOME}/Library/Keychains/login.keychain-db"
            security import apple.cer -k signchain  -T /usr/bin/codesign
            security import gnome.pfx  -k signchain -P "$osx_crt_pw" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple: -k "" signchain
            rm -rf ${HOME}/codesign
      - run:
          name: Creating DMG package
          command: |
            scripts/macports3_build_dmg.sh
          no_output_timeout: 20m
      - run:
          name:  Notarizing DMG package
          command: |
            package/notarize.sh
            if [ -f "${HOME}/Library/Keychains/signchain-db" ]; then
              security delete-keychain signchain
            fi
          no_output_timeout: 20m
      - store_artifacts:
          path: /tmp/artifacts
          destination: builds

workflows:
  version: 2
  build-arm64:
    jobs:
      - dependencies-part1
      - dependencies-part2:
          requires:
            - dependencies-part1
      - dependencies-part3:
          requires:
            - dependencies-part2
      # - dependencies-part4:
      #     requires:
      #       - dependencies-part3
      # - dependencies-part5:
      #     requires:
      #       - dependencies-part4
      - build-gimp-and-package:
          requires:
            - dependencies-part3
